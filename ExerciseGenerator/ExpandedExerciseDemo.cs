using System;
using System.Collections.Generic;
using System.IO;

namespace CursoNET.ExerciseGenerator
{
    /// <summary>
    /// Demostraci√≥n del sistema expandido de generaci√≥n de ejercicios
    /// Incluye biblioteca amplia de ejemplos y generaci√≥n avanzada de prompts
    /// </summary>
    public class ExpandedExerciseDemo
    {
        private readonly ExpandedExerciseGenerator _expandedGenerator;
        private readonly AdvancedPromptGenerator _promptGenerator;

        public ExpandedExerciseDemo()
        {
            _expandedGenerator = new ExpandedExerciseGenerator();
            _promptGenerator = new AdvancedPromptGenerator();
        }

        public static void RunExpandedDemo(string[] args)
        {
            var demo = new ExpandedExerciseDemo();
            
            Console.WriteLine("üöÄ SISTEMA EXPANDIDO DE GENERACI√ìN DE EJERCICIOS .NET");
            Console.WriteLine("=" + new string('=', 60));
            Console.WriteLine();
            
            bool continuar = true;
            while (continuar)
            {
                demo.MostrarMenuPrincipal();
                var opcion = Console.ReadLine();
                
                switch (opcion)
                {
                    case "1":
                        demo.DemostrarEjemplosExistentes();
                        break;
                    case "2":
                        demo.DemostrarGeneracionPrompts();
                        break;
                    case "3":
                        demo.DemostrarConfiguracionPersonalizada();
                        break;
                    case "4":
                        demo.DemostrarGeneracionCompleta();
                        break;
                    case "5":
                        demo.MostrarEjemploPromptCompleto();
                        break;
                    case "0":
                        continuar = false;
                        break;
                    default:
                        Console.WriteLine("‚ùå Opci√≥n inv√°lida. Intente de nuevo.");
                        break;
                }
                
                if (continuar)
                {
                    Console.WriteLine("\nPresione cualquier tecla para continuar...");
                    Console.ReadKey();
                    Console.Clear();
                }
            }
            
            Console.WriteLine("üëã ¬°Hasta luego! Gracias por probar el sistema.");
        }

        private void MostrarMenuPrincipal()
        {
            Console.WriteLine("üìã MEN√ö PRINCIPAL");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 30));
            Console.WriteLine("1. üìö Demostrar Ejercicios con Ejemplos Existentes");
            Console.WriteLine("2. ü§ñ Demostrar Generaci√≥n de Prompts para IA");
            Console.WriteLine("3. ‚öôÔ∏è  Configuraci√≥n Personalizada de Mentor");
            Console.WriteLine("4. üéØ Generaci√≥n Completa de Ejercicio");
            Console.WriteLine("5. üìÑ Mostrar Ejemplo de Prompt Completo");
            Console.WriteLine("0. üö™ Salir");
            Console.WriteLine();
            Console.Write("Seleccione una opci√≥n: ");
        }

        private void DemostrarEjemplosExistentes()
        {
            Console.WriteLine("üìö EJERCICIOS CON EJEMPLOS BEFORE/AFTER EXISTENTES");
            Console.WriteLine("=" + new string('=', 55));
            Console.WriteLine();

            // Ejercicio de refactoring para principiantes
            var configRefactoring = new ExerciseConfiguration
            {
                Level = SkillLevel.Beginner,
                Topic = TopicArea.CSharpFundamentals,
                Type = ExerciseType.Refactoring,
                Context = "Variables",
                EstimatedMinutes = 20,
                IncludeUnitTests = true,
                IncludeExtensionChallenges = true
            };

            Console.WriteLine("üîß EJEMPLO 1: Refactoring de Variables (Principiante)");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 50));
            
            try
            {
                var exerciseRefactoring = _expandedGenerator.GenerateExercise(configRefactoring);
                MostrarResumenEjercicio(exerciseRefactoring);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è Error generado ejercicio: {ex.Message}");
                Console.WriteLine("üí° Esto es normal - este ejercicio usa ejemplos predefinidos en la biblioteca interna.");
            }

            Console.WriteLine();
            
            // Ejercicio de implementaci√≥n para intermedios
            var configImplementation = new ExerciseConfiguration
            {
                Level = SkillLevel.Intermediate,
                Topic = TopicArea.LINQ,
                Type = ExerciseType.Refactoring,
                Context = "LINQ",
                EstimatedMinutes = 30,
                IncludeUnitTests = true
            };

            Console.WriteLine("‚ö° EJEMPLO 2: Refactoring a LINQ (Intermedio)");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 45));
            
            try
            {
                var exerciseLinq = _expandedGenerator.GenerateExercise(configImplementation);
                MostrarResumenEjercicio(exerciseLinq);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ö†Ô∏è Error generado ejercicio: {ex.Message}");
                Console.WriteLine("üí° Esto es normal - este ejercicio usa ejemplos predefinidos en la biblioteca interna.");
            }
        }

        private void DemostrarGeneracionPrompts()
        {
            Console.WriteLine("ü§ñ GENERACI√ìN AVANZADA DE PROMPTS PARA IA");
            Console.WriteLine("=" + new string('=', 45));
            Console.WriteLine();

            // Configuraci√≥n del ejercicio
            var exerciseConfig = new ExerciseConfiguration
            {
                Level = SkillLevel.Intermediate,
                Topic = TopicArea.Collections,
                Type = ExerciseType.Implementation,
                Context = "E-Commerce",
                EstimatedMinutes = 45,
                IncludeUnitTests = true,
                IncludeExtensionChallenges = true
            };

            // Configuraci√≥n del mentor
            var mentorConfig = new MentorConfiguration
            {
                MentorName = "Ana Garc√≠a",
                CourseName = "Desarrollo .NET Avanzado",
                StudentLevel = "Intermedio",
                TeachingStyle = "Pr√°ctico con ejemplos reales",
                IncludeRealWorldExamples = true,
                PreferredExampleDomain = "E-Commerce"
            };

            Console.WriteLine("üìã Configuraci√≥n del Ejercicio:");
            Console.WriteLine($"   Nivel: {exerciseConfig.Level}");
            Console.WriteLine($"   Tema: {exerciseConfig.Topic}");
            Console.WriteLine($"   Tipo: {exerciseConfig.Type}");
            Console.WriteLine($"   Contexto: {exerciseConfig.Context}");
            Console.WriteLine($"   Duraci√≥n: {exerciseConfig.EstimatedMinutes} minutos");
            Console.WriteLine();

            Console.WriteLine("üë©‚Äçüè´ Configuraci√≥n del Mentor:");
            Console.WriteLine($"   Nombre: {mentorConfig.MentorName}");
            Console.WriteLine($"   Curso: {mentorConfig.CourseName}");
            Console.WriteLine($"   Estilo: {mentorConfig.TeachingStyle}");
            Console.WriteLine($"   Dominio: {mentorConfig.PreferredExampleDomain}");
            Console.WriteLine();

            Console.WriteLine("üéØ Generando prompt avanzado con Context Engineering...");
            
            var promptResult = _expandedGenerator.GenerateAIPrompt(exerciseConfig, mentorConfig);
            
            Console.WriteLine("‚úÖ Prompt generado exitosamente!");
            Console.WriteLine();
            Console.WriteLine($"üìä Estad√≠sticas del Prompt:");
            Console.WriteLine($"   Longitud total: {promptResult.CompletePrompt.Length:N0} caracteres");
            Console.WriteLine($"   N√∫mero de par√°metros: {promptResult.PromptParameters.Count}");
            Console.WriteLine($"   Criterios de validaci√≥n: {promptResult.ValidationCriteria.Count}");
            Console.WriteLine();

            Console.WriteLine("üîç Primeros 500 caracteres del prompt:");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 50));
            var preview = promptResult.CompletePrompt.Length > 500 
                ? promptResult.CompletePrompt.Substring(0, 500) + "..."
                : promptResult.CompletePrompt;
            Console.WriteLine(preview);
            Console.WriteLine();
            
            Console.WriteLine("üí° Este prompt incluye:");
            Console.WriteLine("   ‚úÖ Context Engineering avanzado");
            Console.WriteLine("   ‚úÖ Chain of Thought estructurado");
            Console.WriteLine("   ‚úÖ Persona del mentor definida");
            Console.WriteLine("   ‚úÖ Herramientas conceptuales");
            Console.WriteLine("   ‚úÖ Contexto del sistema de cursos");
            Console.WriteLine("   ‚úÖ Framework de pensamiento");
            Console.WriteLine("   ‚úÖ Reflexi√≥n meta-cognitiva");
        }

        private void DemostrarConfiguracionPersonalizada()
        {
            Console.WriteLine("‚öôÔ∏è CONFIGURACI√ìN PERSONALIZADA DE MENTOR Y CURSO");
            Console.WriteLine("=" + new string('=', 52));
            Console.WriteLine();

            // Crear configuraciones personalizadas
            var courseContext = new AdvancedPromptGenerator.CourseSystemContext
            {
                CourseName = "Bootcamp Full-Stack .NET",
                Institution = "TechAcademy Pro",
                CurrentModule = "Arquitectura de Microservicios",
                ModuleNumber = 8,
                TotalModules = 10,
                PreviousModules = new List<string>
                {
                    "Fundamentos de C#",
                    "ASP.NET Core B√°sico",
                    "Entity Framework",
                    "APIs RESTful",
                    "Autenticaci√≥n y Autorizaci√≥n",
                    "Pruebas Unitarias",
                    "Docker y Containerizaci√≥n"
                },
                LearningOutcomes = new List<string>
                {
                    "Dise√±ar arquitecturas de microservicios escalables",
                    "Implementar patrones de comunicaci√≥n entre servicios",
                    "Gestionar datos distribuidos efectivamente"
                }
            };

            var persona = new AdvancedPromptGenerator.PersonaConfiguration
            {
                Name = "Roberto Silva",
                Role = "Lead Solutions Architect",
                Expertise = "Microservices, Cloud Architecture, DevOps",
                YearsOfExperience = 12,
                TeachingPhilosophy = "Aprender resolviendo problemas reales de la industria",
                Specializations = new List<string>
                {
                    "Kubernetes",
                    "Azure Service Fabric",
                    "Event-Driven Architecture",
                    "CQRS y Event Sourcing"
                }
            };

            Console.WriteLine("üéì Contexto del Curso Personalizado:");
            Console.WriteLine($"   üìö Curso: {courseContext.CourseName}");
            Console.WriteLine($"   üè´ Instituci√≥n: {courseContext.Institution}");
            Console.WriteLine($"   üìñ M√≥dulo Actual: {courseContext.CurrentModule} ({courseContext.ModuleNumber}/{courseContext.TotalModules})");
            Console.WriteLine();
            
            Console.WriteLine("   üìã M√≥dulos Completados:");
            foreach (var module in courseContext.PreviousModules)
            {
                Console.WriteLine($"      ‚úÖ {module}");
            }
            Console.WriteLine();

            Console.WriteLine("üë®‚Äçüíº Persona del Mentor:");
            Console.WriteLine($"   üë§ Nombre: {persona.Name}");
            Console.WriteLine($"   üíº Rol: {persona.Role}");
            Console.WriteLine($"   üéØ Expertise: {persona.Expertise}");
            Console.WriteLine($"   üìÖ Experiencia: {persona.YearsOfExperience} a√±os");
            Console.WriteLine($"   üéì Filosof√≠a: {persona.TeachingPhilosophy}");
            Console.WriteLine();
            Console.WriteLine("   üîß Especializaciones:");
            foreach (var spec in persona.Specializations)
            {
                Console.WriteLine($"      ‚ö° {spec}");
            }
            Console.WriteLine();

            Console.WriteLine("üí° Esta configuraci√≥n personalizada permite:");
            Console.WriteLine("   ‚úÖ Ejercicios adaptados al contexto espec√≠fico del curso");
            Console.WriteLine("   ‚úÖ Prompts que reflejan la experiencia del mentor");
            Console.WriteLine("   ‚úÖ Conexiones claras con m√≥dulos previos y futuros");
            Console.WriteLine("   ‚úÖ Nivel de complejidad apropiado para la progresi√≥n");
        }

        private void DemostrarGeneracionCompleta()
        {
            Console.WriteLine("üéØ GENERACI√ìN COMPLETA DE EJERCICIO");
            Console.WriteLine("=" + new string('=', 40));
            Console.WriteLine();

            Console.WriteLine("Seleccione el tipo de ejercicio a generar:");
            Console.WriteLine("1. üìö Ejercicio con ejemplos existentes (Before/After)");
            Console.WriteLine("2. ü§ñ Ejercicio con prompt para IA (sin ejemplos predefinidos)");
            Console.WriteLine();
            Console.Write("Opci√≥n (1 o 2): ");
            
            var option = Console.ReadLine();
            Console.WriteLine();

            if (option == "1")
            {
                GenerarEjercicioConEjemplos();
            }
            else if (option == "2")
            {
                GenerarEjercicioConPrompt();
            }
            else
            {
                Console.WriteLine("‚ùå Opci√≥n inv√°lida.");
            }
        }

        private void GenerarEjercicioConEjemplos()
        {
            Console.WriteLine("üìö GENERANDO EJERCICIO CON EJEMPLOS EXISTENTES");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 48));
            Console.WriteLine();

            var config = new ExerciseConfiguration
            {
                Level = SkillLevel.Beginner,
                Topic = TopicArea.CSharpFundamentals,
                Type = ExerciseType.Refactoring,
                Context = "Variables",
                EstimatedMinutes = 25,
                IncludeUnitTests = true,
                IncludeExtensionChallenges = true,
                OutputPath = "./output/"
            };

            Console.WriteLine("‚öôÔ∏è Configuraci√≥n utilizada:");
            MostrarConfiguracion(config);
            Console.WriteLine();

            Console.WriteLine("üîÑ Generando ejercicio...");
            
            try
            {
                var exercise = _expandedGenerator.GenerateExercise(config);
                
                Console.WriteLine("‚úÖ Ejercicio generado exitosamente!");
                Console.WriteLine();
                
                MostrarEjercicioCompleto(exercise);
                
                // Exportar archivos
                Console.WriteLine("üíæ ¬øDesea exportar los archivos del ejercicio? (s/n): ");
                var exportar = Console.ReadLine()?.ToLower();
                
                if (exportar == "s" || exportar == "si" || exportar == "s√≠")
                {
                    var exportPath = Path.Combine(Directory.GetCurrentDirectory(), "exported-exercises");
                    Directory.CreateDirectory(exportPath);
                    
                    // Usar el generador principal para exportar
                    var mainGenerator = new DotNetExerciseGenerator();
                    mainGenerator.ExportExercise(exercise, exportPath);
                    
                    Console.WriteLine($"üìÅ Archivos exportados en: {exportPath}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‚ùå Error generando ejercicio: {ex.Message}");
                Console.WriteLine();
                Console.WriteLine("üí° Esto puede ocurrir si el ejemplo espec√≠fico no est√° en la biblioteca.");
                Console.WriteLine("   Intente con diferentes combinaciones de Nivel/Tema/Tipo/Contexto.");
            }
        }

        private void GenerarEjercicioConPrompt()
        {
            Console.WriteLine("ü§ñ GENERANDO PROMPT PARA IA (Sin ejemplos predefinidos)");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 58));
            Console.WriteLine();

            var exerciseConfig = new ExerciseConfiguration
            {
                Level = SkillLevel.Advanced,
                Topic = TopicArea.DesignPatterns,
                Type = ExerciseType.Implementation,
                Context = "Banking",
                EstimatedMinutes = 60,
                IncludeUnitTests = true,
                IncludeExtensionChallenges = true
            };

            var mentorConfig = new MentorConfiguration
            {
                MentorName = "Dr. Patricia L√≥pez",
                CourseName = "Arquitectura de Software Empresarial",
                StudentLevel = "Avanzado",
                TeachingStyle = "Te√≥rico-Pr√°ctico",
                IncludeRealWorldExamples = true,
                IncludePerformanceConsiderations = true,
                PreferredExampleDomain = "Banking"
            };

            Console.WriteLine("‚öôÔ∏è Configuraci√≥n del ejercicio:");
            MostrarConfiguracion(exerciseConfig);
            Console.WriteLine();

            Console.WriteLine("üë©‚Äçüè´ Configuraci√≥n del mentor:");
            Console.WriteLine($"   Nombre: {mentorConfig.MentorName}");
            Console.WriteLine($"   Curso: {mentorConfig.CourseName}");
            Console.WriteLine($"   Estilo: {mentorConfig.TeachingStyle}");
            Console.WriteLine($"   Dominio: {mentorConfig.PreferredExampleDomain}");
            Console.WriteLine();

            Console.WriteLine("üîÑ Generando prompt avanzado...");
            
            var promptResult = _expandedGenerator.GenerateAIPrompt(exerciseConfig, mentorConfig);
            
            Console.WriteLine("‚úÖ Prompt generado exitosamente!");
            Console.WriteLine();
            Console.WriteLine($"üìä Estad√≠sticas:");
            Console.WriteLine($"   Longitud: {promptResult.CompletePrompt.Length:N0} caracteres");
            Console.WriteLine($"   Par√°metros: {promptResult.PromptParameters.Count}");
            Console.WriteLine($"   Validaciones: {promptResult.ValidationCriteria.Count}");
            Console.WriteLine();

            Console.WriteLine("üíæ ¬øDesea guardar el prompt en un archivo? (s/n): ");
            var guardar = Console.ReadLine()?.ToLower();
            
            if (guardar == "s" || guardar == "si" || guardar == "s√≠")
            {
                var fileName = $"prompt-{exerciseConfig.Level}-{exerciseConfig.Topic}-{DateTime.Now:yyyyMMdd-HHmmss}.txt";
                var filePath = Path.Combine(Directory.GetCurrentDirectory(), fileName);
                
                File.WriteAllText(filePath, promptResult.CompletePrompt);
                Console.WriteLine($"üìÅ Prompt guardado en: {filePath}");
                Console.WriteLine();
                Console.WriteLine("üí° Puedes copiar este prompt y usarlo con Claude u otra IA para generar el ejercicio completo.");
            }
        }

        private void MostrarEjemploPromptCompleto()
        {
            Console.WriteLine("üìÑ EJEMPLO DE PROMPT COMPLETO CON CONTEXT ENGINEERING");
            Console.WriteLine("=" + new string('=', 58));
            Console.WriteLine();

            var exerciseConfig = new ExerciseConfiguration
            {
                Level = SkillLevel.Intermediate,
                Topic = TopicArea.LINQ,
                Type = ExerciseType.Refactoring,
                Context = "E-Commerce",
                EstimatedMinutes = 40
            };

            var mentorConfig = new MentorConfiguration
            {
                MentorName = "Carlos Mendoza",
                CourseName = "Desarrollo .NET Profesional",
                TeachingStyle = "Pr√°ctico"
            };

            var promptResult = _expandedGenerator.GenerateAIPrompt(exerciseConfig, mentorConfig);

            Console.WriteLine("üéØ Mostrando las primeras secciones del prompt generado:");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 55));
            Console.WriteLine();

            // Mostrar solo las primeras 2000 caracteres para demostraci√≥n
            var promptPreview = promptResult.CompletePrompt.Length > 2000 
                ? promptResult.CompletePrompt.Substring(0, 2000) + "\n\n[... contin√∫a con m√°s secciones ...]"
                : promptResult.CompletePrompt;

            Console.WriteLine(promptPreview);
            Console.WriteLine();
            
            Console.WriteLine("üîç Estructura del prompt completo:");
            Console.WriteLine("   üéØ Contexto del Sistema Educativo");
            Console.WriteLine("   üë®‚Äçüè´ Definici√≥n de Persona Avanzada");
            Console.WriteLine("   üß† Marco de Pensamiento Estructurado (Chain of Thought)");
            Console.WriteLine("   üìö Contexto Espec√≠fico del Ejercicio");
            Console.WriteLine("   üõ†Ô∏è Herramientas Conceptuales Disponibles");
            Console.WriteLine("   üéØ Tarea Principal con CoT");
            Console.WriteLine("   üìã Estructura de Output Requerida");
            Console.WriteLine("   ü§î Reflexi√≥n Meta-cognitiva Final");
            Console.WriteLine();
            
            Console.WriteLine($"üìä Longitud total: {promptResult.CompletePrompt.Length:N0} caracteres");
            Console.WriteLine("üí° Este prompt est√° optimizado para Claude y usa t√©cnicas avanzadas de prompting.");
        }

        private void MostrarConfiguracion(ExerciseConfiguration config)
        {
            Console.WriteLine($"   Nivel: {config.Level}");
            Console.WriteLine($"   Tema: {config.Topic}");
            Console.WriteLine($"   Tipo: {config.Type}");
            Console.WriteLine($"   Contexto: {config.Context}");
            Console.WriteLine($"   Duraci√≥n: {config.EstimatedMinutes} minutos");
            Console.WriteLine($"   Incluir tests: {(config.IncludeUnitTests ? "S√≠" : "No")}");
            Console.WriteLine($"   Incluir extensiones: {(config.IncludeExtensionChallenges ? "S√≠" : "No")}");
        }

        private void MostrarResumenEjercicio(Exercise exercise)
        {
            Console.WriteLine($"   üìù T√≠tulo: {exercise.Title}");
            Console.WriteLine($"   ‚è±Ô∏è Duraci√≥n: {exercise.EstimatedMinutes} minutos");
            Console.WriteLine($"   üéØ Objetivos: {exercise.LearningObjectives.Count}");
            Console.WriteLine($"   ‚úÖ Criterios: {exercise.SuccessCriteria.Count}");
            Console.WriteLine($"   üöÄ Extensions: {exercise.ExtensionChallenges.Count}");
            Console.WriteLine($"   üß™ Tests: {(!string.IsNullOrEmpty(exercise.UnitTestCode) ? "Incluidos" : "No incluidos")}");
        }

        private void MostrarEjercicioCompleto(Exercise exercise)
        {
            Console.WriteLine("üìã EJERCICIO GENERADO:");
            Console.WriteLine("‚îÄ" + new string('‚îÄ', 25));
            Console.WriteLine($"üìù **T√≠tulo**: {exercise.Title}");
            Console.WriteLine($"‚è±Ô∏è **Duraci√≥n**: {exercise.EstimatedMinutes} minutos");
            Console.WriteLine($"üìä **Nivel**: {exercise.Level} | **Tema**: {exercise.Topic} | **Tipo**: {exercise.Type}");
            Console.WriteLine();
            
            Console.WriteLine("üìñ **Descripci√≥n**:");
            Console.WriteLine($"   {exercise.Description}");
            Console.WriteLine();
            
            Console.WriteLine($"üéØ **Objetivos de Aprendizaje** ({exercise.LearningObjectives.Count}):");
            for (int i = 0; i < exercise.LearningObjectives.Count; i++)
            {
                Console.WriteLine($"   {i + 1}. {exercise.LearningObjectives[i]}");
            }
            Console.WriteLine();
            
            Console.WriteLine($"‚úÖ **Criterios de √âxito** ({exercise.SuccessCriteria.Count}):");
            for (int i = 0; i < exercise.SuccessCriteria.Count; i++)
            {
                Console.WriteLine($"   ‚úì {exercise.SuccessCriteria[i]}");
            }
            Console.WriteLine();
            
            if (exercise.ExtensionChallenges.Count > 0)
            {
                Console.WriteLine($"üöÄ **Desaf√≠os de Extensi√≥n** ({exercise.ExtensionChallenges.Count}):");
                for (int i = 0; i < exercise.ExtensionChallenges.Count; i++)
                {
                    Console.WriteLine($"   + {exercise.ExtensionChallenges[i]}");
                }
                Console.WriteLine();
            }
            
            Console.WriteLine("üíª **C√≥digo**:");
            Console.WriteLine($"   üìÑ C√≥digo inicial: {exercise.StarterCode?.Length ?? 0} caracteres");
            Console.WriteLine($"   ‚úÖ Soluci√≥n: {exercise.SolutionCode?.Length ?? 0} caracteres");
            Console.WriteLine($"   üß™ Tests: {(!string.IsNullOrEmpty(exercise.UnitTestCode) ? exercise.UnitTestCode.Length + " caracteres" : "No incluidos")}");
        }
    }
}